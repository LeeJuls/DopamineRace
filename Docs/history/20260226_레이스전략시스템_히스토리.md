# 레이스 전략 시스템 구현 히스토리

**날짜**: 2026-02-26
**작업자**: Claude (claude-sonnet-4-6)
**관련 명세서**: `Docs/specs/20260226_레이스전략시스템_명세서.md`

---

## 작업 개요

기존 단순 zone(inZone/outZone) 기반 HP 소모 로직을 4페이즈 전략 시스템으로 교체.
각 타입(도주/선행/선입/추입)이 레이스 구간별로 다른 전략적 행동을 취하도록 구현.

---

## 구현 단계

### Step 1 — GameSettings.cs 파라미터 추가 + asset 수정

**추가 필드** (7개):
```
positioningLapEnd = 0.5f      // 포지셔닝 구간 끝 (랩 단위)
formationHoldLapEnd = 1.0f    // 대형유지 구간 끝
runner_posTarget = 0.25f      // 도주 목표 순위 상위 25%
leader_posTarget = 0.50f      // 선행 목표 순위 상위 50%
chaser_posTarget = 0.75f      // 선입 목표 순위 상위 75%
formationGapMax = 0.3f        // 대형유지 최대 간격 (랩 단위)
formationGapMin = 0.05f       // 대형유지 최소 간격
```

**추가 메서드**: `GetPositioningTarget(CharacterType type)`
→ Runner=0.25, Leader=0.50, Chaser=0.75, Reckoner=-1(항상보존)

**asset 수정**:
- `chaser_spurtStart`: 0.40 → **0.20** (선입 마지막 20% 스퍼트)
- `reckoner_spurtStart`: 0.40 → **0.30** (추입 마지막 30% 스퍼트)

검증: Unity 컴파일 성공 ✓, MCP 런타임 값 확인 ✓

---

### Step 2 — RacerController.cs ConsumeHP() 재작성

**기존**: 단일 메서드 ~81줄 (spurtStart 기준 2구간)
**신규**: 8개 메서드 ~295줄 (4페이즈 아키텍처)

#### 메서드 구조

```
ConsumeHP()               — 디스패처 (TotalProgress 기반 라우팅)
├── ConsumeHP_Legacy()    — 1랩 레이스 fallback (기존 로직 보존)
├── ConsumeHP_Positioning() — Phase 1: 포지셔닝 (0 ~ positioningLapEnd)
├── ConsumeHP_FormationHold() — Phase 2: 대형유지 (positioningLapEnd ~ formationHoldLapEnd)
├── ConsumeHP_Strategy()  — Phase 3: 전략 (formationHoldLapEnd 이후)
├── ApplyHPConsumption()  — 공통 tail (boostAmp, speedRatio, leadPaceTax)
├── IsUpperTrack()        — 상행 여부 (Runner || Leader)
└── GetLastUpperTrackProgress() — 상행 최소 TotalProgress
```

#### Phase별 로직 요약

| 페이즈 | 도주 | 선행 | 선입 | 추입 |
|--------|------|------|------|------|
| Phase 1 (포지셔닝) | top25% 목표 | top50% 목표 | top75% 목표 | 항상 보존 |
| Phase 2 (대형유지) | top25% 유지 | top50% 유지 | 상행침범 금지+간격 유지 | 상행침범 금지+보존 |
| Phase 3 (전략) | 무조건 스프린트 | top30%+여유>10% → 보존 | top70%+여유>20% → 보존 | 여유>30% → 보존 |

검증: Unity 컴파일 성공 (Tundra build success) ✓

---

### Step 3 — RaceBacktestWindow.cs SimConsumeHP() 재작성

**기존**: 단일 `SimConsumeHP()` 72줄
**신규**: 7개 메서드 ~240줄 (RacerController 미러링)

**추가 내용**:
- `private List<SimRacer> _activeRacers;` 클래스 필드
- `_activeRacers = racers;` (RunSimulation에서 배정)

#### RacerController → BacktestWindow 매핑

| RacerController | BacktestWindow | 비고 |
|-----------------|----------------|------|
| `ConsumeHP()` | `SimConsumeHP()` | `progress * simLaps` = TotalProgress |
| `ConsumeHP_Legacy()` | `SimConsumeHP_Legacy()` | 1랩 fallback |
| `ConsumeHP_Positioning()` | `SimConsumeHP_Positioning()` | |
| `ConsumeHP_FormationHold()` | `SimConsumeHP_FormationHold()` | rank 기반 근사 |
| `ConsumeHP_Strategy()` | `SimConsumeHP_Strategy()` | |
| `ApplyHPConsumption()` | `SimApplyHPConsumption()` | |
| `GetLastUpperTrackProgress()` | `SimGetLastUpperTrackProgress()` | `pos/17f` 근사 |

**Phase 2 대형유지 근사** (백테스트는 정확한 TotalProgress 없음):
- `rank <= topHalf` → 강제 보존 (상행 영역 침범)
- `rank > topHalf + 2` → 스프린트 (간격 초과)
- else → 보존

검증: Unity 컴파일 성공 ✓

---

## 수정 파일 목록

| 파일 | 변경 내용 | Lines +/- |
|------|-----------|-----------|
| `Assets/Scripts/Data/GameSettings.cs` | 필드 7개 + GetPositioningTarget() | +36 |
| `Assets/Resources/GameSettings.asset` | spurtStart 2개 변경 | ~+4 |
| `Assets/Scripts/Racer/RacerController.cs` | ConsumeHP 4페이즈 재작성 | ~+255 / -38 |
| `Assets/Scripts/Editor/RaceBacktestWindow.cs` | SimConsumeHP 미러링 재작성 | ~+209 |

---

## 검증 결과

### 컴파일
- Step 1: ✓ Tundra build success (no CS errors)
- Step 2: ✓ Tundra build success (no CS errors)
- Step 3: ✓ 컴파일 성공 확인

### 백테스트 (예정)
- `DopamineRace > 백테스팅` 메뉴에서 4바퀴, 100+ 레이스 실행 필요
- 목표 승률: R=20%, L=30%, C=30%, K=20% (±5%)

> **주의**: MCP 인라인 스크립트로 시도한 백테스트는 신뢰할 수 없음.
> 노이즈/CP/슬립스트림/충돌 시스템이 없어 Runner 100% 편향 발생.
> 반드시 실제 RaceBacktestWindow 사용 필요.

---

## 설계 결정 사항

### 1. leaderSpurtMinHP 체크 제거
Strategy 페이즈에서 Leader의 `leaderSpurtMinHP` 조건 제거.
기존: HP가 충분할 때만 스퍼트 허용 → 선행이 너무 소극적
변경: 순위 조건(top30%)만으로 스퍼트 결정 → 보다 공격적인 선행

### 2. 1랩 레이스 Legacy 유지
`totalLaps < 2`이면 기존 로직 그대로 사용.
테스트/특수 트랙을 위한 안전장치.

### 3. 백테스트의 대형유지 근사
실제 코드의 `GetLastUpperTrackProgress()`는 RaceManager를 통해 다른 레이서의 실제 위치를 참조하지만, 백테스트에서는 `position / 17f`(17m 트랙 가정)로 근사.
이 근사는 Phase 2(0.5~1.0랩)에만 적용되므로 전체 결과에 미치는 영향 최소.

---

## 알려진 이슈 / 후속 과제

1. **4바퀴 백테스트 미실행** — 실제 RaceBacktestWindow로 검증 필요
2. **2바퀴 / 6바퀴 검증** — 4바퀴 튜닝 완료 후 진행
3. **런타임 테스트** — 비주얼/타이밍 실제 플레이 확인 필요
4. **파라미터 미세 조정** — 백테스트 결과에 따라 `posTarget`, `formationGap` 조정 가능성 있음
