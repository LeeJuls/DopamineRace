# 캐릭터 데이터 리팩토링 히스토리

**날짜**: 2026-02-25
**작업자**: Claude (AI Assistant)
**커밋 범위**: Phase 1~6 (7 Phase 계획 중)

---

## 1. 작업 목적

캐릭터 식별자 시스템의 3가지 구조적 문제를 해결:

1. **UID 부재**: `charName`이 Loc 키이면서 UID 역할을 겸하고 있어 의미가 불명확
2. **1-based 넘버링**: `str.char.001~012`로 1부터 시작 — 코드의 0-based 인덱싱과 불일치
3. **프리팹 네이밍 혼란**: 일반 프리팹 `Character_12~23`, 어택 프리팹 `Character_0~11` (대응관계 불명)

## 2. 리팩토링 결과

### 식별자 체계 변경

| 항목 | 변경 전 | 변경 후 |
|---|---|---|
| UID | 없음 (charName이 겸용) | `charId` = `char.leader.thunder.000` |
| Loc 키 | `charName` = `str.char.001.name` | `charName` = `str.char.000.name` (0-based) |
| 넘버링 | 001~012 (1-based) | 000~011 (0-based) |
| 어택 프리팹 | `Character_0~11.prefab` | `Character_12_Attack~Character_23_Attack.prefab` |

### 캐릭터 매핑 테이블

| charId | charName | 이름(ko) | 타입 | 프리팹 | 어택 프리팹 |
|---|---|---|---|---|---|
| char.leader.thunder.000 | str.char.000.name | 번개 | Leader | Character_12 | Character_12_Attack |
| char.runner.typhoon.001 | str.char.001.name | 태풍 | Runner | Character_13 | Character_13_Attack |
| char.reckoner.comet.002 | str.char.002.name | 혜성 | Reckoner | Character_14 | Character_14_Attack |
| char.leader.rocket.003 | str.char.003.name | 로켓 | Leader | Character_15 | Character_15_Attack |
| char.chaser.flame.004 | str.char.004.name | 불꽃 | Chaser | Character_16 | Character_16_Attack |
| char.leader.gale.005 | str.char.005.name | 질풍 | Leader | Character_17 | Character_17_Attack |
| char.chaser.lightning.006 | str.char.006.name | 천둥 | Chaser | Character_18 | Character_18_Attack |
| char.runner.meteor.007 | str.char.007.name | 유성 | Runner | Character_19 | Character_19_Attack |
| char.runner.storm.008 | str.char.008.name | 폭풍 | Runner | Character_20 | Character_20_Attack |
| char.chaser.flash.009 | str.char.009.name | 섬광 | Chaser | Character_21 | Character_21_Attack |
| char.reckoner.tsunami.010 | str.char.010.name | 해일 | Reckoner | Character_22 | Character_22_Attack |
| char.reckoner.fairy.011 | str.char.011.name | 선녀 | Reckoner | Character_23 | Character_23_Attack |

---

## 3. Phase별 작업 내역

### Phase 1: CharacterDB.csv — char_id 컬럼 추가 + 0-base 리넘버링

**파일**: `Assets/Resources/Data/CharacterDB.csv`

- col 0에 `char_id` 컬럼 추가 (기존 컬럼 전부 +1 시프트)
- `char_name`: `str.char.001~012` → `str.char.000~011`
- `char_skill_desc`: 동일하게 0-base 리넘버링
- 최종 컬럼 수: 17개 (헤더 포함)

### Phase 2: StringTable.csv — 키 0-base 리넘버링

**파일**: `Assets/Resources/Data/StringTable.csv`

- 36개 키 변경: 12 name + 12 ability + 12 skill.desc
- `str.char.001.*` → `str.char.000.*` ... `str.char.012.*` → `str.char.011.*`
- Python 스크립트로 원자적(atomic) 치환 (순차 replace 충돌 방지)

### Phase 3: CharacterData.cs — charId 필드 + ParseCSVLine 시프트

**파일**: `Assets/Scripts/Data/CharacterData.cs`

- `charId` 필드 추가 (string)
- `ParseCSVLine()`: 모든 인덱스 +1 시프트 (col 0 → charId)
- `cols.Length < 11` 가드 → `cols.Length < 12`

### Phase 4: 전체 코드베이스 charName→charId 마이그레이션 (16개 파일)

record/lookup에서 `charName`을 `charId`로 교체. `charName`은 순수 Loc 키 용도로만 유지.

| # | 파일 | 주요 변경 |
|---|---|---|
| 1 | CharacterRecord.cs | `charName` 필드 → `charId` |
| 2 | ScoreManager.cs | `charId` + `SAVE_VERSION=2` + `CleanupInvalidCharRecords` |
| 3 | GameManager.cs | `cd.charId` UID + DisplayName 버그 수정 |
| 4 | OddsCalculator.cs | 매개변수 + 비교문 전부 `charId` |
| 5 | PopularityInfo.cs | `charName` → `charId` |
| 6 | BetRecord.cs | `selectedCharNames` → `selectedCharIds` |
| 7 | SceneBootstrapper.Betting.cs | `CurrentCharId` + lookup 키 |
| 8 | CharacterInfoPopup.cs | `currentCharId` + `CurrentCharId` |
| 9 | CharacterDatabase.cs | `FindById(string charId)` 메서드 추가 |
| 10 | RacerController.cs | `GetConditionMultiplier(charData.charId)` |
| 11 | RaceDebugOverlay.cs | `GetCharDisplayName(charId)` 헬퍼 추가 |
| 12 | TitleCharacterRunner.cs | Debug.Log charId |
| 13 | RaceBacktestWindow.cs | 딕셔너리 키 + `charIds` 변수명 |
| 14 | Phase2IntegrationTest.cs | charId 검증 추가 + DisplayName 비교 버그 수정 |

**세이브 데이터 처리**:
- `SAVE_VERSION = 2` (ScoreManager.Awake에서 체크)
- 구버전 → PlayerPrefs 전체 삭제 후 재초기화
- `CleanupInvalidCharRecords()`: `StartsWith("str.")` → `StartsWith("char.")`

**기존 버그 수정**:
- GameManager.CalcScore: `CharData.DisplayName` → `CharData.charId` (배팅 기록에 DisplayName 저장하던 버그)
- Phase2IntegrationTest: `RACER_NAMES[i] == charName` → `DisplayName` 비교

### Phase 5: Pixem 제작 툴 커스텀 네이밍

**파일**: `PixemManager.cs`, `PixemUIManager.cs`

- `Text CharacterPrefabName` → `InputField CharacterPrefabNameInput`
- 기본값: 기존 자동 넘버링 (`Character_{N}`)
- 사용자 직접 이름 입력 가능
- 중복 이름 체크 + 경고 다이얼로그
- 정렬: 숫자 프리팹 우선, 커스텀 이름 알파벳순

### Phase 6: 어택 프리팹 리네이밍

Unity MCP C# 스크립트로 일괄 처리:

- 12개 프리팹: `Character_0~11.prefab` → `Character_12_Attack~Character_23_Attack.prefab`
- 12개 리소스 폴더: `CharacterResources/Character_0~11/` → `Character_12_Attack~Character_23_Attack/`
- `AssetDatabase.MoveAsset` 사용 (GUID 보존)
- CharacterDB.csv의 `char_attack_resource_prefabs` 경로 업데이트

---

## 4. 검증 결과

### 컴파일 상태
- Assembly-CSharp: 성공 (에러 없음)
- Assembly-CSharp-Editor: 성공 (에러 없음)

### CharacterDB.csv 파싱 (12/12)
- charId: 전부 `char.type.name.NNN` 형식 (PASS)
- charName: 전부 `str.char.NNN.name` 0-based (PASS)
- Attack prefab: 전부 `_Attack` 접미사 포함 (PASS)

### StringTable.csv (36/36)
- 12 name + 12 ability + 12 skill.desc
- `str.char.000.name` → "번개" (PASS)
- `str.char.011.name` → "선녀" (PASS)

### Attack Prefab 파일 존재
- `Character_12_Attack` ~ `Character_23_Attack.prefab`: 12/12 존재 (PASS)

---

## 5. 수정 파일 전체 목록 (21개)

| # | 파일 | Phase |
|---|---|---|
| 1 | `Assets/Resources/Data/CharacterDB.csv` | 1, 6 |
| 2 | `Assets/Resources/Data/StringTable.csv` | 2 |
| 3 | `Assets/Scripts/Data/CharacterData.cs` | 3 |
| 4 | `Assets/Scripts/Data/Record/CharacterRecord.cs` | 4 |
| 5 | `Assets/Scripts/Manager/ScoreManager.cs` | 4 |
| 6 | `Assets/Scripts/Manager/GameManager.cs` | 4 |
| 7 | `Assets/Scripts/Utility/OddsCalculator.cs` | 4 |
| 8 | `Assets/Scripts/Data/PopularityInfo.cs` | 4 |
| 9 | `Assets/Scripts/Data/Record/BetRecord.cs` | 4 |
| 10 | `Assets/Scripts/Manager/UI/SceneBootstrapper.Betting.cs` | 4 |
| 11 | `Assets/Scripts/Manager/UI/CharacterInfoPopup.cs` | 4 |
| 12 | `Assets/Scripts/Data/CharacterDatabase.cs` | 4 |
| 13 | `Assets/Scripts/Racer/RacerController.cs` | 4 |
| 14 | `Assets/Scripts/Editor/RaceBacktestWindow.cs` | 4 |
| 15 | `Assets/Scripts/Debug/RaceDebugOverlay.cs` | 4 |
| 16 | `Assets/Scripts/Manager/TitleCharacterRunner.cs` | 4 |
| 17 | `Assets/Scripts/Tests/Phase2IntegrationTest.cs` | 4 |
| 18 | `Assets/Pixem/Scripts/PixemManager.cs` | 5 |
| 19 | `Assets/Pixem/Scripts/PixemUIManager.cs` | 5 |
| 20 | `Assets/Pixem/Resources/CharacterPrefabs/` (12 리네이밍) | 6 |
| 21 | `Assets/Pixem/Resources/CharacterResources/` (12 폴더 리네이밍) | 6 |

---

## 6. 주의사항 / 후속 작업

### Unity Inspector 수동 작업 필요
- **PixemUIManager**: `CharacterPrefabNameInput` (InputField) 필드가 `Text`에서 `InputField`로 타입 변경됨
  → Pixem 에디터 씬에서 InputField 컴포넌트 수동 연결 필요

### 세이브 데이터
- `SAVE_VERSION = 2`로 인해 기존 플레이 데이터 자동 초기화
- 개발 중이므로 의도된 동작

### charName vs charId 사용 규칙
- `charId`: record lookup, 딕셔너리 키, 배팅 기록, 시리얼라이즈
- `charName`: `Loc.Get()` 호출, `.Replace(".name", ".ability")` 등 Loc 키 파생
- `DisplayName`: UI 표시용 (`Loc.Get(charName)` 반환값)

### 런타임 테스트 미완료
- 실제 Play 모드에서의 전체 흐름 테스트 필요
- 백테스팅 시뮬레이션 charId 기반 동작 확인 필요
