# 히스토리: 백테스팅 툴 안정화 + 확장

## 날짜
2026-02-24

## 관련 스펙
- SPEC-005-백테스팅툴-안정화-확장.md

## 수정 파일
- `Assets/Scripts/Editor/RaceBacktestWindow.cs` (636 insertions, 268 deletions)
- `.gitignore` (Docs/logs/ 추가 — 이전 커밋 c1b3b9e)

---

## 작업 과정

### 1. 문제 발견
- 사용자가 백테스팅 실행 → "시뮬레이션 중..." 표시 후 3분 이상 멈춤
- Unity 콘솔에 `FormatException: Input string was not in a correct format` 확인
- 에러 위치: `BuildAllTracksResult()` 내 `StringBuilder.AppendFormat`

### 2. 근본 원인 분석
- **진짜 원인**: `{1,+6:F2}` 포맷 — Mono의 `StringBuilder.AppendFormat`에서 alignment `+` 미지원
- **부가 원인**: `{N:+0.00;-0.00}` section format도 Mono에서 불안정
- **치명적 부작용**: 예외가 `isRunning = false` 도달 전에 발생 → 버튼 영구 잠김
- 시뮬레이션 자체는 정상 완료되었으나, 결과 렌더링에서 크래시

### 3. FormatException 수정
- `{N,+M:F2}` → `{N,M:F2}` (alignment에서 `+` 제거)
- `+0.00;-0.00` → `SF()` 헬퍼 함수로 전면 교체
- `SF(float v)`: 양수 "+1.23", 음수 "-0.45" 반환
- 타입 보너스 테이블(Runner/Leader/Chaser/Reckoner)도 동일 패턴 수정

### 4. try-catch-finally 안전 래핑
- `RunAllTracksSimulation()`: try-catch-finally로 `RunAllTracksSimulationInternal()` 감쌈
- `RunSingleTrackSimulation()`: 동일 패턴 적용
- finally 블록에서 `isRunning = false` + `EditorUtility.ClearProgressBar()` 보장
- Internal 메서드 내 중복 cleanup 코드 제거

### 5. GC 최적화
- `UpdateSimCooldowns()`: 매 스텝 `new List<int>()` 2개 → 클래스 필드 재사용
- `_expiredKeys`, `_tempKeys` (capacity=32) — `.Clear()` 후 재활용

### 6. 프로그래스 바 + 취소
- `EditorUtility.DisplayCancelableProgressBar` — 10레이스마다 갱신
- 트랙별/레이스별 진행률 표시
- 취소 시 `cancelRequested` 플래그 처리

### 7. 캐릭터 이름 한국어 표시
- `BuildAllTracksResult` 진입 시 `Loc.SetLang("ko")` → ko 이름 딕셔너리 구축
- 완료 후 원래 언어 복원
- `KN()` 람다로 모든 출력 위치 교체 (display + md 양쪽)

### 8. 캐릭터 기록 초기화 메뉴
- `DopamineRace > 캐릭터 기록 초기화` MenuItem 추가
- `CharacterRecordResetMenu` static 클래스
- 확인 다이얼로그 → PlayerPrefs 키 삭제 → 완료 알림

---

## 테스트 결과
- 백테스팅 정상 동작 확인 (사용자 보고)
- FormatException 재발 없음
- 프로그래스 바 표시 + 취소 기능 동작
- 캐릭터 이름 한국어로 정상 출력

---

## 발견된 교훈
- **Mono의 `StringBuilder.AppendFormat`는 .NET과 포맷 호환성이 다름**
  - alignment specifier에 `+` 사용 불가
  - `+0.00;-0.00` section format도 불안정할 수 있음
  - 안전 대안: 커스텀 `SF()` 헬퍼 사용
- **Editor 스크립트에서 예외 미처리 시 상태 플래그 영구 잠김 가능**
  - 반드시 try-catch-finally 또는 try-finally 사용
